<!DOCTYPE html>
<html lang="ko">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>간단한 GIF 변환기</title>
  <style>
    /* 스타일 생략 (이전 그대로 유지됨) */
    /* 필요하면 여기에 다시 포함시켜 드릴게요 */
  </style>
</head>
<body>
  <div id="gif-converter-container">
    <h1>간단한 GIF 변환기</h1>
    <h2>Convert your videos to GIF</h2>
    <div id="drop-zone">
      <img class="main-icon" src="https://i.postimg.cc/Qd05H1nJ/image-icon.png" alt="Video to GIF Icon"/>
      <label id="file-label" for="file-input">
        동영상 파일 선택<br>Select Video files
        <small>또는 여기에 동영상 드롭 / or drop videos here</small>
      </label>
      <input type="file" id="file-input" accept="video/*" />
    </div>

    <video id="video-preview" controls style="display:none;"></video>
    <img id="gif-preview" alt="Converted GIF" style="display:none;"/>

    <div class="controls">
      <div class="control-group">
        <label for="start-time">시작 시간 (초)</label>
        <input type="number" id="start-time" value="0" min="0" step="0.1" disabled/>
      </div>
      <div class="control-group">
        <label for="end-time">종료 시간 (초)</label>
        <input type="number" id="end-time" value="0" min="0" step="0.1" disabled/>
      </div>
      <div class="control-group">
        <label for="fps">초당 프레임 수 (FPS)</label>
        <select id="fps" disabled>
          <option value="10">10 FPS (낮음)</option>
          <option value="15">15 FPS (보통)</option>
          <option value="20" selected>20 FPS (좋음)</option>
          <option value="25">25 FPS (높음)</option>
        </select>
      </div>
    </div>

    <div class="buttons-group">
      <button id="convert-btn" disabled>변환 시작</button>
      <button id="download-btn" disabled>다운로드</button>
    </div>

    <div id="output"></div>

    <div class="program-description">
      <ul>
        <li>✓ 다양한 동영상 파일을 GIF로 변환합니다.</li>
        <li>✓ 시작/종료 시간 설정 및 FPS 조절 가능</li>
        <li>✓ 브라우저에서 직접 실행되어 파일 전송 없음</li>
        <li>✓ 드래그 앤 드롭 및 클릭 지원</li>
      </ul>
    </div>
  </div>

  <!-- FFmpeg 라이브러리 로드 -->
  <script src="https://unpkg.com/@ffmpeg/ffmpeg@0.12.4/dist/ffmpeg.min.js"></script>

  <script>
    const { createFFmpeg, fetchFile } = FFmpeg;
    const ffmpeg = createFFmpeg({ log: true });

    const dropZone = document.getElementById('drop-zone');
    const fileInput = document.getElementById('file-input');
    const fileLabel = document.getElementById('file-label');
    const videoPreview = document.getElementById('video-preview');
    const gifPreview = document.getElementById('gif-preview');
    const startTimeInput = document.getElementById('start-time');
    const endTimeInput = document.getElementById('end-time');
    const fpsSelect = document.getElementById('fps');
    const convertBtn = document.getElementById('convert-btn');
    const downloadBtn = document.getElementById('download-btn');
    const output = document.getElementById('output');

    let videoFile = null;

    // 🛡️ body 전체에서 기본 drag 이벤트 막기
    ['dragover', 'drop'].forEach(event => {
      document.body.addEventListener(event, (e) => {
        e.preventDefault();
        e.stopPropagation();
      });
    });

    // ✅ 드롭존 동작 정의
    dropZone.addEventListener('dragover', (e) => {
      e.preventDefault();
      e.stopPropagation();
      dropZone.classList.add('dragover');
    });

    dropZone.addEventListener('dragleave', () => {
      dropZone.classList.remove('dragover');
    });

    dropZone.addEventListener('drop', (e) => {
      e.preventDefault();
      e.stopPropagation();
      dropZone.classList.remove('dragover');
      if (e.dataTransfer.files.length > 0) {
        handleFile(e.dataTransfer.files[0]);
      }
    });

    fileInput.addEventListener('change', (e) => {
      handleFile(e.target.files[0]);
    });

    function handleFile(file) {
      if (!file || !file.type.startsWith('video/')) {
        output.textContent = '동영상 파일만 업로드할 수 있습니다.';
        return;
      }

      videoFile = file;
      const videoUrl = URL.createObjectURL(videoFile);
      videoPreview.src = videoUrl;
      videoPreview.style.display = 'block';
      gifPreview.style.display = 'none';
      dropZone.style.display = 'none';
      fileLabel.innerHTML = `✅ ${file.name}<br>파일 선택됨`;

      videoPreview.onloadedmetadata = () => {
        endTimeInput.value = videoPreview.duration.toFixed(1);
        startTimeInput.disabled = false;
        endTimeInput.disabled = false;
        fpsSelect.disabled = false;
        convertBtn.disabled = false;
        downloadBtn.disabled = true;
        output.textContent = '설정을 조절한 후 변환을 시작하세요.';
      };

      videoPreview.onerror = () => {
        output.textContent = '동영상 미리보기에 실패했습니다.';
      };
    }

    convertBtn.addEventListener('click', async () => {
      if (!videoFile) {
        output.textContent = '파일을 먼저 선택하세요.';
        return;
      }

      const startTime = parseFloat(startTimeInput.value);
      const endTime = parseFloat(endTimeInput.value);
      const duration = endTime - startTime;
      const fps = parseInt(fpsSelect.value);

      if (startTime >= endTime || duration <= 0) {
        output.textContent = '시작 시간이 종료 시간보다 빠르거나 같습니다.';
        return;
      }

      convertBtn.disabled = true;
      output.textContent = '변환 중입니다... 잠시만 기다려주세요.';

      try {
        if (!ffmpeg.isLoaded()) {
          await ffmpeg.load();
        }

        await ffmpeg.FS('writeFile', videoFile.name, await fetchFile(videoFile));

        await ffmpeg.run(
          '-ss', startTime.toString(),
          '-to', endTime.toString(),
          '-i', videoFile.name,
          '-vf', `fps=${fps},scale=320:-1:flags=lanczos`,
          'output.gif'
        );

        const data = await ffmpeg.FS('readFile', 'output.gif');
        const gifBlob = new Blob([data.buffer], { type: 'image/gif' });
        const gifUrl = URL.createObjectURL(gifBlob);

        gifPreview.src = gifUrl;
        gifPreview.style.display = 'block';
        videoPreview.style.display = 'none';
        downloadBtn.disabled = false;
        output.textContent = '변환 완료! 다운로드 버튼을 눌러 저장하세요.';
      } catch (err) {
        console.error(err);
        output.textContent = '변환 중 오류가 발생했습니다.';
      } finally {
        convertBtn.disabled = false;
      }
    });

    downloadBtn.addEventListener('click', () => {
      if (!gifPreview.src) return;
      const link = document.createElement('a');
      link.href = gifPreview.src;
      link.download = 'converted.gif';
      link.click();
    });
  </script>
</body>
</html>
